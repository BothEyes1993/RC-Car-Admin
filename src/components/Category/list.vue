<template>
  <div>
    <template v-if="selectModel">
      <el-tree
        node-key="id"
        :props="treeProps"
        :data="treeList"
        show-checkbox
        :default-checked-keys="selectModelKeys"
        @check="handleSelectionChange"
      />
    </template>
    <template v-else>
      <div class="divBox">
        <el-card class="box-card">
          <div slot="header" class="clearfix">
            <div class="container">
              <el-form inline size="small">
                <el-form-item>
                  <el-select v-model="listPram.status" placeholder="状态" clearable class="selWidth">
                    <el-option
                      v-for="item in constants.roleListStatus"
                      :key="item.value"
                      :label="item.label"
                      :value="item.value"
                    />
                  </el-select>
                </el-form-item>
                <el-form-item>
                  <el-input v-model="listPram.name" placeholder="名称" clearable class="selWidth"/>
                </el-form-item>
                <el-form-item>
                  <el-button size="mini" @click="handlerGetList">查询</el-button>
                </el-form-item>
              </el-form>
            </div>
            <el-button size="mini" type="primary" @click="handleAddMenu({id:0,name:'顶层目录'})">新增{{ biztype.name }}</el-button>
          </div>
          <el-table
            ref="treeList"
            :data="treeList"
            size="mini"
            class="table"
            highlight-current-row
            row-key="id"
            :tree-props="{children: 'child', hasChildren: 'hasChildren'}"
          >
            <el-table-column prop="name" label="名称" min-width="200">
              <template slot-scope="scope">
                {{ scope.row.name }} | {{ scope.row.id }}
              </template>
            </el-table-column>
            <template v-if="!selectModel">
              <el-table-column label="类型" min-width="150">
                <template slot-scope="scope">
                  <span>{{ scope.row.type | filterCategroyType | filterEmpty }}</span>
                </template>
              </el-table-column>
              <el-table-column label="分类图标" min-width="80">
                <template slot-scope="scope">
                  <div class="listPic" v-if=" biztype.value === 5 ">
                    <i :class="'el-icon-' + scope.row.extra" style="font-size: 20px;" />
                  </div>
                  <div class="demo-image__preview" v-else>
                    <el-image
                      style="width: 36px; height: 36px"
                      :src="scope.row.extra"
                      :preview-src-list="[scope.row.extra]"
                    />
                  </div>
                </template>
              </el-table-column>
              <el-table-column label="Url" min-width="250">
                <template slot-scope="scope">
                  <span>{{ scope.row.url }}</span>
                </template>
              </el-table-column>
              <el-table-column label="排序" prop="sort" min-width="150" />
              <el-table-column label="启用状态" width="150">
                <template slot-scope="scope">
                  <span>{{ scope.row.status | filterYesOrNo }}</span>
                </template>
              </el-table-column>
              <el-table-column label="操作" min-width="200" fixed="right">
                <template slot-scope="scope">
                  <el-button
                    v-if="biztype.value!==3 && scope.row.pid === 0"
                    type="text"
                    size="small"
                    @click="handleAddMenu(scope.row)"
                  >添加子目录</el-button>
                  <el-button type="text"  size="small" @click="handleEditMenu(scope.row)">编辑</el-button>
                  <el-button type="text"  size="small" @click="handleDelMenu(scope.row)">删除</el-button>
                </template>
              </el-table-column>
            </template>
          </el-table>
        </el-card>
      </div>
    </template>
    <el-dialog
      :title="(editDialogConfig.isCreate===0?`创建${biztype.name}`:`编辑${biztype.name}`)"
      :visible.sync="editDialogConfig.visible"
      destroy-on-close
      :close-on-click-modal="false"
    >
      <edit
        v-if="editDialogConfig.visible"
        :prent="editDialogConfig.prent"
        :is-create="editDialogConfig.isCreate"
        :edit-data="editDialogConfig.data"
        :biztype="editDialogConfig.biztype"
        :all-tree-list="treeList"
        @hideEditDialog="hideEditDialog"
      />
    </el-dialog>
  </div>
</template>

<script>
import * as categoryApi from '@/api/categoryApi.js'
import edit from './edit'
import * as constants from '@/utils/constants.js'
import * as selfUtil from '@/utils/ZBKJIutil.js'
export default {
  // name: "list"
  components: { edit },
  props: {
    biztype: { // 类型，1 产品分类，2 附件分类，3 文章分类， 4 设置分类， 5 菜单分类
      type: Object,
      default: () => {
        return -1
      },
      validator: (obj) => {
        return obj.value > 0
      }
    },
    pid: {
      type: Number,
      default: 0,
      validator: (value) => {
        return value >= 0
      }
    },
    selectModel: { // 是否选择模式
      type: Boolean,
      default: false
    },
    selectModelKeys: {
      type: Array
    },
    rowSelect: {}
  },
  data () {
    return {
      constants,
      treeProps: {
        label: 'name',
        children: 'child',
        expandTrigger: 'hover',
        checkStrictly: true,
        emitPath: false
      },
      // treeCheckedKeys:[],// 选择模式下的属性结构默认选中
      multipleSelection: [],
      editDialogConfig: {
        visible: false,
        isCreate: 0, // 0=创建，1=编辑
        prent: {}, // 父级对象
        data: {},
        biztype: this.biztype // 统一主业务中的目录类型
      },
      dataList: [],
      treeList: [],
      listPram: {
        pid: this.pid,
        type: this.biztype.value,
        status: null,
        name: null,
        page: constants.page.page,
        limit: constants.page.limit[0]
      },
      viewInfoConfig: {
        data: null,
        visible: false
      }
    }
  },
  mounted () {
    // if(this.biztype.value === 3){
    //   this.listPram.pageSize = constants.page.pageSize[4]
    //   this.handlerGetList()
    // }else{
    this.handlerGetTreeList()
    // }
  },
  methods: {
    handleEditMenu (rowData) {
      this.editDialogConfig.isCreate = 1
      this.editDialogConfig.data = rowData
      this.editDialogConfig.prent = rowData
      this.editDialogConfig.visible = true
    },
    handleAddMenu (rowData) {
      this.editDialogConfig.isCreate = 0
      this.editDialogConfig.prent = rowData
      this.editDialogConfig.data = {}
      this.editDialogConfig.biztype = this.biztype
      this.editDialogConfig.visible = true
    },
    handleDelMenu (rowData) {
      this.$confirm('确定删除当前数据?').then(() => {
        categoryApi.deleteCategroy(rowData).then(data => {
          this.handlerGetTreeList()
          this.$message.success('删除成功')
        })
      })
    },
    handlerGetList () {
      categoryApi.listCategroy(this.listPram).then(data => {
        this.treeList = data.list
      })
    },
    handlerGetTreeList () {
      const _pram = { type: this.biztype.value, status: this.selectModel ? 1 : -1 }
      this.biztype.value !== 3 ? categoryApi.treeCategroy(_pram).then(data => {
        this.treeList = this.handleAddArrt(data)
      }) : categoryApi.listCategroy({ type: 3, status: '', pid: this.listPram.pid }).then(data => {
        this.treeList = data.list
      })
    },
    handlerGetInfo (id) {
      this.viewInfoConfig.data = id
      this.viewInfoConfig.visible = true
    },
    handleNodeClick (data) {
      console.log('data:', data)
    },
    handleAddArrt (treeData) {
      // let _result = this.addTreeListLabel(treeData)
      const _result = selfUtil.addTreeListLabel(treeData)
      return _result
    },
    hideEditDialog () {
      setTimeout(() => {
        this.editDialogConfig.prent = {}
        this.editDialogConfig.type = 0
        this.editDialogConfig.visible = false
        this.handlerGetTreeList()
      }, 200)
    },
    handleSelectionChange (d1, { checkedNodes, checkedKeys, halfCheckedNodes, halfCheckedKeys }) {
      // this.multipleSelection =  checkedKeys.concat(halfCheckedKeys)
      this.multipleSelection = checkedKeys
      this.$emit('rulesSelect', this.multipleSelection)
    }
  }
}
</script>

<style scoped>
  .custom-tree-node {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 14px;
    padding-right: 8px;
  }
</style>
